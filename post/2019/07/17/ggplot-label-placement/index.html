<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> ggplot label placement | BIO-SPRING</title>
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xiee/utils@v1.13.54/css/article.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xiee/utils/css/heading-anchor.min.css">
    <link rel="stylesheet" href="/bio-spring/css/style.css" />
    <link rel="stylesheet" href="/bio-spring/css/fonts.css" />
    <link rel="stylesheet" href="/bio-spring/css/custom.css" />
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ggplot label placement">
  <meta name="twitter:description" content="本文曾经发表在 biobabble 微信公众号 链接
ggplot在绘制label的时候很容易出现字体溢出，位置难以调整的问题。Y叔曾经在公众号上吐槽过。
实际上，标签如何在图片中展示，还真不是一个简单的问题。有一个领域“Automatic label placement”就是研究该问题的。
下面介绍一下如何处理这个标签定位的问题。
方法一：使用hjust，vjust，nudge_x，nudge_y等参数调整 我们从mpg数据集中提取10行数据画图，默认情况下是这样的情况。
mpg数据集是ggplot2自带的一个234行和11个变量的数据，包含了38种流行车型的燃油经济性数据。
包括：生产厂家（manufacturer），型号（model），发动机排量（displ，单位为L），生产年份（year），气缸数目（cyl），传动类型（trans），驱动类型（drv，f=前驱，r=后驱，4=四驱），每加仑燃油在城市和高速公路上的里程数（cty和hwy），汽油种类（fl）和汽车类型（class）等。
library(ggplot2) ## 生成数据集 set.seed(0) df &lt;- mpg[sample(nrow(mpg),10),] ## 发动机排量和良好路况情况下单位耗油所能行驶的里程数 ggplot(df,aes(displ,hwy)) &#43; geom_point() &#43; geom_text(aes(label=model)) 这种情况下，边缘的字符串会溢出。可以添加hjust=&#34;inward&#34;来避免这一情况。
## hjust=&#34;inward&#34;把左侧的label右对齐，右侧的label左对齐。 ggplot(df,aes(displ,hwy)) &#43; geom_point() &#43; geom_text(aes(label=model),hjust=&#34;inward&#34;) 但是这种情形仍然会出现point和label重叠的情况。因此需要进一步调节。使用nudge_x和nudge_y可以设置标签显示位置的微小偏移。
由于标签是水平显示的，左右两侧容易出现溢出，而竖直方向上则一般不会，所以我们将竖直方向设为居中，并微调-0.5，这样就可以保证标签显示比较正常了。
ggplot(df,aes(displ,hwy)) &#43; geom_point() &#43; geom_text(aes(label=model),hjust=&#34;inward&#34;,vjust=&#34;center&#34;,nudge_y = -.5) hjust, vjust = c(“left”,“right”,“center”,“inward”,“outward”); nudge_x, nudge_y = value.
如果在Y轴边缘有溢出的话，则在结合调整xlim，ylim可以解决。如下所示：
ggplot(df,aes(displ,hwy)) &#43; geom_point() &#43; geom_text(aes(label=model),size=12,hjust=&#34;inward&#34;,vjust=&#34;center&#34;,nudge_y = -.5) &#43; xlim(c(0,8)) 如上图所示，虽然确保了标签没有溢出，但是同时又会有标签重叠的情况。">


  </head>

  <body>

    <nav class="menu sticky-top">
    <ul>
      <li class="left">
        <a href="/"><span>BIO-SPRING</span></a>
      </li>
      
      <li>
        <a href="/bio-spring">Home</a>
      </li>
      
      <li>
        <a href="/bio-spring/post/">Blog Post</a>
      </li>
      
      <li>
        <a href="/bio-spring/publication/full-publication-list/">Publication</a>
      </li>
      
      <li>
        <a href="/bio-spring/work/">Work</a>
      </li>
      
      <li id="menu-search">
        <a href="/bio-spring/#">Search</a>
      </li>
      
    </ul>
    </nav>


<div class="container single">
<main>

<div class="article-meta">
<h1><span class="title">ggplot label placement</span></h1>

<h3 class="author">
gaoch
</h3>

<h3 class="date">2019-07-17</h3>
<p class="terms">
  
  
  Categories: <a href="/categories/%E4%BF%A1%E6%81%AF%E6%8A%80%E6%9C%AF">信息技术</a> 
  
  
  
  Tags: <a href="/tags/ggplot2">ggplot2</a> <a href="/tags/r">R</a> <a href="/tags/ggrepel">ggrepel</a> <a href="/tags/directlabel">directlabel</a> 
  
  
</p>
</div>

<div class="article">
<p><em>本文曾经发表在 biobabble 微信公众号 <a href="https://mp.weixin.qq.com/s/6MMVsO22n9oKZNC7qC7g5A">链接</a></em></p>
<p>ggplot在绘制label的时候很容易出现字体溢出，位置难以调整的问题。Y叔曾经在公众号上吐槽过。</p>
<p>实际上，标签如何在图片中展示，还真不是一个简单的问题。有一个领域“<a href="https://en.wikipedia.org/wiki/Automatic_label_placement">Automatic label placement</a>”就是研究该问题的。</p>
<p>下面介绍一下如何处理这个标签定位的问题。</p>
<h2 id="方法一使用hjustvjustnudge_xnudge_y等参数调整">方法一：使用hjust，vjust，nudge_x，nudge_y等参数调整</h2>
<p>我们从mpg数据集中提取10行数据画图，默认情况下是这样的情况。</p>
<blockquote>
<p>mpg数据集是ggplot2自带的一个234行和11个变量的数据，包含了38种流行车型的燃油经济性数据。</p>
</blockquote>
<blockquote>
<p>包括：生产厂家（manufacturer），型号（model），发动机排量（displ，单位为L），生产年份（year），气缸数目（cyl），传动类型（trans），驱动类型（drv，f=前驱，r=后驱，4=四驱），每加仑燃油在城市和高速公路上的里程数（cty和hwy），汽油种类（fl）和汽车类型（class）等。</p>
</blockquote>
<pre><code class="language-r">library(ggplot2)
## 生成数据集
set.seed(0)
df &lt;- mpg[sample(nrow(mpg),10),]

## 发动机排量和良好路况情况下单位耗油所能行驶的里程数
ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_text(aes(label=model))
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-1-1.png" width="672" />
<p>这种情况下，边缘的字符串会溢出。可以添加<code>hjust=&quot;inward&quot;</code>来避免这一情况。</p>
<pre><code class="language-r">## hjust=&quot;inward&quot;把左侧的label右对齐，右侧的label左对齐。
ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_text(aes(label=model),hjust=&quot;inward&quot;)
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-2-1.png" width="672" />
<p>但是这种情形仍然会出现point和label重叠的情况。因此需要进一步调节。使用<code>nudge_x</code>和<code>nudge_y</code>可以设置标签显示位置的微小偏移。</p>
<p>由于标签是水平显示的，左右两侧容易出现溢出，而竖直方向上则一般不会，所以我们将竖直方向设为居中，并微调-0.5，这样就可以保证标签显示比较正常了。</p>
<pre><code class="language-r">ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_text(aes(label=model),hjust=&quot;inward&quot;,vjust=&quot;center&quot;,nudge_y = -.5)
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-3-1.png" width="672" />
<blockquote>
<p>hjust, vjust = c(&ldquo;left&rdquo;,&ldquo;right&rdquo;,&ldquo;center&rdquo;,&ldquo;inward&rdquo;,&ldquo;outward&rdquo;);
nudge_x, nudge_y = value.</p>
</blockquote>
<p>如果在Y轴边缘有溢出的话，则在结合调整xlim，ylim可以解决。如下所示：</p>
<pre><code class="language-r">ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_text(aes(label=model),size=12,hjust=&quot;inward&quot;,vjust=&quot;center&quot;,nudge_y = -.5) + 
  xlim(c(0,8))
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-4-1.png" width="672" />
<p>如上图所示，虽然确保了标签没有溢出，但是同时又会有标签重叠的情况。</p>
<blockquote>
<p>也可以参考 vignette(&ldquo;ggplot2-specs&rdquo;) 中的部分内容。</p>
</blockquote>
<p>实际上，标签如何在图片中展示，还真不是一个简单的问题。有一个领域“<a href="https://en.wikipedia.org/wiki/Automatic_label_placement">Automatic label placement</a>”就是研究该问题的。</p>
<p>不过，有一些R包可以帮助我们解决这一难题。</p>
<h2 id="方法二ggrepel">方法二：ggrepel</h2>
<p>ggrepel包就是为了处理ggplot label而开发的。</p>
<pre><code class="language-r">library(ggrepel)
</code></pre>
<pre><code>## Warning: package 'ggrepel' was built under R version 4.3.3
</code></pre>
<pre><code class="language-r">## 使用geom_text_repel可以一步完成上面类似的操作
ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_text_repel(aes(label=model))
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-5-1.png" width="672" />
<blockquote>
<p>更多信息，请参考ggrepel文档中的ggrepel examples</p>
</blockquote>
<h2 id="方法三directlabels">方法三：directlabels</h2>
<p>directlabels则是另外一个选择。这个包不仅能够用于ggplot图，还可以用于latitice基础绘图系统。</p>
<pre><code class="language-r">## 安装和载入
# install.packages(&quot;directlabels&quot;)
library(&quot;directlabels&quot;)

## 看一下效果
ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_dl(aes(label=model),method = &quot;smart.grid&quot;)
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-6-1.png" width="672" />
<p>这个smart.grid方法特别适合于point作图中points非常多的情况，避免使用legend，让图片更美观更易读。</p>
<p>比较一下下面两幅图，显然后者更好。</p>
<pre><code class="language-r">## 使用legend和颜色
ggplot(mpg,aes(displ,hwy,color=class)) + 
  geom_point()
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-7-1.png" width="672" />
<pre><code class="language-r">## 使用label和颜色
ggplot(mpg,aes(displ,hwy,color=class)) + 
  geom_point(show.legend=F) + 
  geom_dl(aes(label=class),method=&quot;smart.grid&quot;)
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-7-2.png" width="672" />
<blockquote>
<p>geom_dl这里有一个method参数，可以有“last.points”，“first.points”，“top.qp”，“first.qp”，“last.qp”，“smart.grid”等不同选择。针对不同的绘图类型会有不同的可选项。</p>
</blockquote>
<blockquote>
<p>不同作图类型可用的方法可以参见：http://directlabels.r-forge.r-project.org/docs/index.html</p>
</blockquote>
<h2 id="外check_overlap">外：check_overlap</h2>
<p><code>check_overlap</code>也是<code>ggplot2</code>的<code>geom_text</code>自带的一个小参数，可以避免label重叠。应用时，会依次检查后面的label是否与前面的重叠，有重叠的话，就不显示。</p>
<pre><code class="language-r">## df数据集含有mpg中的十行数据
ggplot(df,aes(displ,hwy)) + 
  geom_point() + 
  geom_text(aes(label=model),check_overlap=T)
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-8-1.png" width="672" />
<pre><code class="language-r">## mpg数据集含有234行数据
ggplot(mpg,aes(displ,hwy)) + 
  geom_point() + 
  geom_text(aes(label=model),check_overlap=T)
</code></pre>
<img src="bio-spring/post/2019/07/17/ggplot-label-placement/index.zh_files/figure-html/unnamed-chunk-8-2.png" width="672" />
<p>这个参数，label少的时候用不上，label多的时候也不能随便用。食之无味，弃之可惜。鸡肋啊~~</p>

</div>
</main>

<section class="appendix">


<div>
  <div class="side side-left"><h3>作者简介</h3></div>
  <div>





<div>Chun-Hui Gao is a Research Associate at <a href="http://www.hzau.edu.cn">Huazhong Agricultural University</a>.</div>


</div>
</div>






<div>
  <div class="side side-left"><h3>重复使用</h3></div>
  Text and figures are licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution CC BY 4.0</a>. The source code is licensed under MIT. The full source is available at <a href="https://github.com/yihui/hugo-prose">https://github.com/yihui/hugo-prose</a>.
</div>



<div>
  <div class="side side-left"><h3>欢迎修订</h3></div>
  
  
  
    
  
  如果您发现本文里含有任何错误（包括错别字和标点符号），欢迎<a href="https://github.com/gaospecial/bio-spring/edit/master/content/post/2019-07-17-ggplot-label-placement/index.zh.Rmd" id="edit-link">在本站的 GitHub 项目里提交修订意见。</a>
</div>




<div>
  <div class="side side-left"><h3>引用本文</h3></div>
  <p>如果您使用了本文的内容，请按照以下方式引用：</p>
  <pre><code>gaoch (2019). ggplot label placement. BIO-SPRING. bio-spring/post/2019/07/17/ggplot-label-placement/</code></pre>
  <p>BibTeX citation</p>
  <pre><code>@misc{
  title = "ggplot label placement",
  author = "gaoch",
  year = "2019",
  journal = "BIO-SPRING",
  note = "bio-spring/post/2019/07/17/ggplot-label-placement/"
}</code></pre>
</div>

</section>



<nav class="post-nav">
  <span class="nav-next">&larr; <a href="bio-spring/post/2019/07/17/tibble-data-frame-group/" title=下一篇&#32;(旧)>Tibble与Data.frame中的group</a></span>
  &hercon;
  <span class="nav-prev"><a href="bio-spring/post/2019/07/29/letter-3/" title=上一篇&#32;(新)>Letter 3: On True and False Friendship</a> &rarr;</span>
</nav>




<section class="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var disqus_js = '//bio-spring.disqus.com/embed.js';
    var d = document, s = d.createElement('script');
    s.src = disqus_js; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    var t = d.getElementById('disqus_thread');
    var b = false, l = function(scroll) {
      if (b) return;
      (d.head || d.body).appendChild(s); b = true;
      if (scroll) t.scrollIntoView();
    }
    s.onerror = function(e) {
      if (sessionStorage.getItem('failure-note')) return;
      t.innerText = 'Sorry, but you cannot make comments because Disqus failed to load for some reason. It is known to be blocked in China. If you are sure it is not blocked in your region, please refresh the page. 中国大陆地区读者需要翻墙才能发表评论。';
      t.style.border = '1px dashed';
      t.style.padding = '.5em';
      t.style.background = 'lightyellow';
      sessionStorage.setItem('failure-note', true);
    };
    
    if (location.hash.match(/^#comment-[0-9]+$/)) return l(true);
    var c = function() {
      if (b) return;
      var rect = t.getBoundingClientRect();
      if (rect.top < window.innerHeight && rect.bottom >= 0) l();
    };
    window.addEventListener('load', c);
    d.addEventListener('scroll', c);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


</div>


  <footer>
  
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>





      <script async src="https://www.googletagmanager.com/gtag/js?id=G-77M8KZTCMR"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-77M8KZTCMR');
        }
      </script>


<script src="https://cdn.jsdelivr.net/combine/npm/@xiee/utils/js/number-sections.min.js,npm/@xiee/utils/js/toc.min.js,npm/@xiee/utils/js/toc-highlight.min.js,npm/@xiee/utils/js/sidenotes.min.js,npm/@xiee/utils/js/right-quote.min.js,npm/@xiee/utils/js/center-img.min.js,npm/@xiee/utils/js/fix-pandoc.min.js,npm/@xiee/utils/js/heading-anchor.min.js" defer></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xiee/utils/css/prism-xcode.min.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>


  <div class="footer">
  
  <ul class="copyright">
    <li>© <a href="https://bio-spring.top">Bio-Spring</a> 2006 &ndash; 2025 <a href="https://beian.miit.gov.cn">豫ICP备2021003240号</a></li>
  </ul>
  
  <ul>
    
    <li>
      <a href="/bio-spring/404.html">Contact</a>
    </li>
    
    <li class="optional">
      <a href="/bio-spring/categories/">Categories</a>
    </li>
    
    <li class="optional">
      <a href="/bio-spring/tags/">Tags</a>
    </li>
    
    <li id="menu-edit">
      <a href="#">Suggest an edit</a>
    </li>
    
    <li>
      <a href="#">Back to top</a>
    </li>
    
  </ul>
  </div>
  
  </footer>
  <script src="/bio-spring/js/features.js" defer></script>
  </body>
</html>

