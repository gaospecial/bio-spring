<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Webhook on BIO-SPRING</title>
    <link>bio-spring/tags/webhook/</link>
    <description>Recent content in Webhook on BIO-SPRING</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Mon, 04 Nov 2024 00:00:00 +0000</lastBuildDate>
    <atom:link href="bio-spring/tags/webhook/" rel="self" type="application/rss+xml" />

    
      <item>
        <title>GitHub Webhook</title>
        <link>bio-spring/post/2024/11/04/github-webhook/</link>
        <pubDate>Mon, 04 Nov 2024 00:00:00 +0000</pubDate>
        <author>gaoch</author>
        <guid>bio-spring/post/2024/11/04/github-webhook/</guid>
        <description>
          &lt;p&gt;使用 GitHub Webhook 自动更新个人网站。&lt;a href=&#34;https://bio-spring.top&#34;&gt;bio-spring.top&lt;/a&gt; 是我的个人网站，其源代码托管在 &lt;a href=&#34;https://github.com/gaospecial/bio-spring&#34;&gt;GitHub&lt;/a&gt; 上。通过使用 GitHub Actions 可以自动构建网站并部署到 GitHub Pages，实现自动更新网站在 &lt;a href=&#34;https://gaospecial.github.io/bio-spring/&#34;&gt;gaospecial.github.io/bio-spring/&lt;/a&gt; 上的展示。通过使用 netlify 可以实现自动更新网站在 netlify 服务器上的展示。现在想要自动化部署到我的阿里云服务器上，该如何实现呢？&lt;/p&gt;
&lt;p&gt;这里要用到几个部分的技术：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;GitHub Webhook&lt;/li&gt;
&lt;li&gt;配置 Hook server&lt;/li&gt;
&lt;li&gt;设置 Hook server 要执行的任务&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;配置-github-webhook&#34;&gt;配置 GitHub Webhook&lt;/h2&gt;
&lt;p&gt;GitHub Webhook 是一种自动化工具，它允许在 GitHub 仓库发生特定事件时向外部服务器发送通知。当配置的事件（如 push、pull request 等）发生时，GitHub 会向指定的 URL 发送 HTTP POST 请求，包含相关事件的详细信息。&lt;/p&gt;
&lt;h3 id=&#34;访问-webhook-设置&#34;&gt;访问 Webhook 设置&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;进入 GitHub 仓库&lt;/li&gt;
&lt;li&gt;点击 &amp;ldquo;Settings&amp;rdquo; 选项卡&lt;/li&gt;
&lt;li&gt;在左侧菜单中选择 &amp;ldquo;Webhooks&amp;rdquo;&lt;/li&gt;
&lt;li&gt;点击 &amp;ldquo;Add webhook&amp;rdquo; 按钮&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;配置-webhook&#34;&gt;配置 Webhook&lt;/h3&gt;
&lt;p&gt;在添加 Webhook 时需要设置以下内容：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Payload URL&lt;/strong&gt;: 接收 webhook 请求的服务器地址&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;例如：&lt;code&gt;http://webhook.bio-spring.top/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;确保该 URL 可以从公网访问&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Content type&lt;/strong&gt;: 选择数据传输格式&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;通常选择 &lt;code&gt;application/json&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Secret&lt;/strong&gt;: 设置密钥（可选但推荐）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;用于验证请求来源的合法性&lt;/li&gt;
&lt;li&gt;确保安全传输&lt;/li&gt;
&lt;li&gt;生成一个随机的秘钥字符串：&lt;code&gt;openssl rand -hex 20&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;事件触发选项&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&amp;ldquo;Just the push event&amp;rdquo;: 仅推送事件&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Send me everything&amp;rdquo;: 所有事件&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Let me select individual events&amp;rdquo;: 自定义选择事件&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;配置完成后，GitHub 会向指定的 URL 发送一个 ping 事件来测试连接。&lt;/p&gt;
&lt;h2 id=&#34;配置-hook-server&#34;&gt;配置 Hook server&lt;/h2&gt;
&lt;p&gt;上面配置完，会得到一个提示“Last delivery was not successful”，这是因为还没有配置 Hook server。接下来做这部分工作。&lt;/p&gt;
&lt;h3 id=&#34;配置-hook-server-的-url&#34;&gt;配置 Hook server 的 URL&lt;/h3&gt;
&lt;p&gt;要配置 webhook.bio-spring.top，需要在 Apache2 中添加一个虚拟主机配置。具体步骤如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;创建虚拟主机配置文件：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-apache&#34;&gt;&amp;lt;VirtualHost *:443&amp;gt;
    # 设置服务器名称
    ServerName webhook.bio-spring.top
    ServerAlias webhook.bio-spring.top

    # 启用 SSL
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/webhook.bio-spring.top/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/webhook.bio-spring.top/privkey.pem

    # 设置日志路径
    ErrorLog ${APACHE_LOG_DIR}/webhook-error.log
    CustomLog ${APACHE_LOG_DIR}/webhook-access.log combined

    # 设置文档根目录
    DocumentRoot /var/www/html/webhook
&amp;lt;/VirtualHost&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;重启 Apache 服务：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo a2ensite webhook.conf
sudo service apache2 restart
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;添加 DNS 解析&lt;/p&gt;
&lt;p&gt;在 DNS 解析中添加 webhook.bio-spring.top 的解析，指向阿里云服务器的公网 IP 地址。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;配置 https 证书&lt;/p&gt;
&lt;p&gt;在阿里云服务器上安装 certbot 并配置 https 证书。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;sudo apt install certbot
sudo certbot --apache -d webhook.bio-spring.top
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;配置-hook-server-的脚本&#34;&gt;配置 Hook Server 的脚本&lt;/h3&gt;
&lt;p&gt;在 Hook Server 的文档根目录下创建一个 &lt;code&gt;index.php&lt;/code&gt; 文件，内容如下：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php
// 配置
$secret = &amp;quot;your-secret-key&amp;quot;;
$log_file = &amp;quot;/var/log/webhook/deploy-php.log&amp;quot;;
$deploy_script = &amp;quot;/path/to/deploy-hook.sh&amp;quot;;

// 记录日志
function write_log($message) {
    global $log_file;
    $date = date(&#39;Y-m-d H:i:s&#39;);
    file_put_contents($log_file, &amp;quot;[$date] $message\n&amp;quot;, FILE_APPEND);
}

// 验证签名
function verify_signature($payload, $signature) {
    global $secret;
    $expected = &amp;quot;sha256=&amp;quot; . hash_hmac(&#39;sha256&#39;, $payload, $secret);
    return hash_equals($expected, $signature);
}

// 确保是POST请求
if ($_SERVER[&#39;REQUEST_METHOD&#39;] !== &#39;POST&#39;) {
    http_response_code(405);
    die(&#39;Method Not Allowed&#39;);
}

// 获取GitHub签名
$headers = getallheaders();
$signature = isset($headers[&#39;X-Hub-Signature-256&#39;]) ? $headers[&#39;X-Hub-Signature-256&#39;] : &#39;&#39;;

if (empty($signature)) {
    write_log(&amp;quot;Error: No signature provided&amp;quot;);
    http_response_code(403);
    die(&#39;No signature&#39;);
}

// 获取请求体
$payload = file_get_contents(&#39;php://input&#39;);

// 验证签名
if (!verify_signature($payload, $signature)) {
    write_log(&amp;quot;Error: Invalid signature&amp;quot;);
    http_response_code(403);
    die(&#39;Invalid signature&#39;);
}

// 解析payload
$data = json_decode($payload, true);

// 检查是否是push事件
if (isset($data[&#39;ref&#39;]) &amp;amp;&amp;amp; $data[&#39;ref&#39;] === &#39;refs/heads/master&#39;) {
    write_log(&amp;quot;Received push to master branch&amp;quot;);
    
    // 执行部署脚本
    $output = [];
    $return_var = 0;
    exec(&amp;quot;bash $deploy_script 2&amp;gt;&amp;amp;1&amp;quot;, $output, $return_var);
    
    // 记录执行结果
    $output_str = implode(&amp;quot;\n&amp;quot;, $output);
    write_log(&amp;quot;Deploy script output:\n$output_str&amp;quot;);
    
    if ($return_var === 0) {
        write_log(&amp;quot;Deploy completed successfully&amp;quot;);
        echo &amp;quot;Deploy successful&amp;quot;;
    } else {
        write_log(&amp;quot;Deploy failed with code $return_var&amp;quot;);
        http_response_code(500);
        echo &amp;quot;Deploy failed&amp;quot;;
    }
} else {
    write_log(&amp;quot;Ignored non-master push event&amp;quot;);
    echo &amp;quot;Ignored&amp;quot;;
}
?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;重启 Apache 服务器之后，访问 webhook.bio-spring.top 应该会返回 &amp;ldquo;Method Not Allowed&amp;rdquo;。&lt;/p&gt;
&lt;h3 id=&#34;配置-deploy-hooksh-脚本&#34;&gt;配置 deploy-hook.sh 脚本&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;#!/bin/bash

# 设置工作目录
SITE_DIR=&amp;quot;/var/www/html/bio-spring.top&amp;quot;
LOG_FILE=&amp;quot;/var/log/webhook/deploy-sh.log&amp;quot;
REPO_DIR=&amp;quot;/home/git/bio-spring&amp;quot;

# 如果日志文件不存在则创建
if [ ! -f &amp;quot;$LOG_FILE&amp;quot; ]; then
    mkdir -p &amp;quot;$(dirname &amp;quot;$LOG_FILE&amp;quot;)&amp;quot;
    touch &amp;quot;$LOG_FILE&amp;quot;
    chown www-data:www-data &amp;quot;$LOG_FILE&amp;quot;
    chmod 644 &amp;quot;$LOG_FILE&amp;quot;
fi


# 记录部署时间
echo &amp;quot;Deployment started at $(date)&amp;quot; &amp;gt;&amp;gt; $LOG_FILE

# 更新代码仓库
cd $REPO_DIR || exit
GIT_SSH_COMMAND=&#39;ssh -i /home/git/.ssh/id_rsa&#39; git pull origin master &amp;gt;&amp;gt; $LOG_FILE 2&amp;gt;&amp;amp;1
GIT_SSH_COMMAND=&#39;ssh -i /home/git/.ssh/id_rsa&#39; git submodule update --recursive &amp;gt;&amp;gt; $LOG_FILE 2&amp;gt;&amp;amp;1

# 安装 hugo
# wget https://github.com/gohugoio/hugo/releases/download/v0.136.5/hugo_0.136.5_linux-amd64.deb
# dpkg -i hugo_0.136.5_linux-amd64.deb

# 构建网站
Rscript -e &#39;blogdown::build_site(baseURL = &amp;quot;/&amp;quot;)&#39; &amp;gt;&amp;gt; $LOG_FILE 2&amp;gt;&amp;amp;1

# 同步到网站目录
rsync -av --delete public/ $SITE_DIR/ &amp;gt;&amp;gt; $LOG_FILE 2&amp;gt;&amp;amp;1

echo &amp;quot;Deployment completed at $(date)&amp;quot; &amp;gt;&amp;gt; $LOG_FILE
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;测试&#34;&gt;测试&lt;/h2&gt;
&lt;p&gt;在 GitHub 仓库中推送代码，应该会看到阿里云服务器上的网站自动更新。同时，GitHub Webhook 的日志中也会记录 delivery 信息。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;：由于 GitHub Webhook 的超时时间为 10 s，如果超过 10 s 没有响应（脚本没有执行完毕），GitHub 的状态会显示为“time out”。这种情况可以通过异步执行脚本解决。或者也可以忽略。&lt;/p&gt;
&lt;h3 id=&#34;异步执行脚本&#34;&gt;异步执行脚本&lt;/h3&gt;
&lt;p&gt;在 PHP 中实现异步处理，可以使用 &lt;code&gt;exec()&lt;/code&gt; 或 &lt;code&gt;shell_exec()&lt;/code&gt; 命令来启动后台进程。通过在命令末尾添加 &lt;code&gt;&amp;amp;&lt;/code&gt; 符号，可以让该进程在后台运行，而不阻塞主进程。&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;// 异步启动任务
exec(&amp;quot;bash /path/to/deploy-hook.sh &amp;amp;&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;以上代码会在后台执行 &lt;code&gt;deploy-hook.sh&lt;/code&gt;，避免输出内容影响主进程。&lt;/p&gt;

        </description>
      </item>
    
  </channel>
</rss>
